#!/bin/bash

UNDERLINE="\e[4m"
GREEN="\e[0;32m"
YELLOW="\e[0;33m"
RESET="\e[0m"

echo "=============================="
echo " Git uploader ‚Äì smart & enkel hantering (v2.3) üòÑ"
echo "=============================="
echo

echo -e "${YELLOW}‚û°Ô∏è  Vill du skapa ett nytt repo eller uppdatera ett befintligt? (ny/befintlig): ${RESET}"
read REPOCHOICE

create_gitignore() {
    echo "‚û°Ô∏è  F√∂rbereder .gitignore..."
    if [ -f "package.json" ]; then
        TYPE="Node.js"
        cat > .gitignore <<EOL
# Node.js
node_modules/
npm-debug.log
.env
EOL
    elif [ -f "requirements.txt" ] || ls *.py 1> /dev/null 2>&1; then
        TYPE="Python"
        cat > .gitignore <<EOL
# Python
__pycache__/
*.pyc
*.pyo
*.pyd
*.egg-info/
.env
EOL
    elif ls *.php 1> /dev/null 2>&1; then
        TYPE="PHP"
        cat > .gitignore <<EOL
# PHP
vendor/
*.log
.env
EOL
    else
        TYPE="Allm√§nt"
        cat > .gitignore <<EOL
# Allm√§nt
*.log
*.tmp
.env
EOL
    fi
    echo "‚úÖ .gitignore skapad f√∂r $TYPE-projekt (inkluderar alltid .env)."
}

set_branch_if_missing() {
    CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
    if [ -z "$CURRENT_BRANCH" ]; then
        read -p "üí° Vill du anv√§nda 'main' eller 'master' som huvudbranch? (main/master): " BRANCH
        BRANCH=${BRANCH:-main}
        git branch -M $BRANCH
        CURRENT_BRANCH=$BRANCH
    fi
}

set_user_if_missing() {
    if ! git config user.name >/dev/null; then
        echo -e "${YELLOW}‚û°Ô∏è  Ange Git-anv√§ndarnamn f√∂r detta repo:${RESET}"
        read GITUSER
        git config user.name "$GITUSER"

        echo -e "${YELLOW}‚û°Ô∏è  Ange Git-email f√∂r detta repo:${RESET}"
        read GITEMAIL
        git config user.email "$GITEMAIL"
    fi
}

add_with_preview() {
    echo "üìÑ Filer som √§ndrats sedan senaste commit:"
    git status --short
    echo
    echo -e "${YELLOW}‚û°Ô∏è  Vill du forts√§tta och l√§gga till alla dessa filer? (j/n): ${RESET}"
    read CONFIRM_ADD
    if [[ "$CONFIRM_ADD" =~ ^[Jj]$ ]]; then
        git add .
        echo "‚úÖ √Ñndringar tillagda."
    else
        echo "‚è≠Ô∏è  Hoppar √∂ver git add."
    fi
    echo
}

push_to_github() {
    echo -e "${YELLOW}‚ö†Ô∏è  Observera: Du m√•ste ha skapat repo p√• GitHub f√∂rst!${RESET}"
    read -p "üîó Ange GitHub-repo URL: " REMOTEURL
    git remote add origin "$REMOTEURL"

    set_branch_if_missing

    git push -u origin $CURRENT_BRANCH
    echo "‚úÖ Push till GitHub klar."
}

if [[ "$REPOCHOICE" =~ ^[Nn]y$ ]]; then
    if [ -d ".git" ]; then
        echo "‚ö†Ô∏è  Git-repo redan existerar h√§r!"
    else
        git init
        echo "‚úÖ Git-repo initierat."

        create_gitignore
        set_user_if_missing

        git add .
        git commit -m "F√∂rsta commit"
        echo "‚úÖ F√∂rsta commit skapad."

        echo "‚û°Ô∏è  Vill du pusha detta repo till GitHub nu? (j/n): "
        read PUSH
        if [[ "$PUSH" =~ ^[Jj]$ ]]; then
            push_to_github
        else
            echo "‚è≠Ô∏è  Push hoppades √∂ver."
        fi
    fi
else
    if [ ! -d ".git" ]; then
        echo "‚ùå Detta √§r inte ett Git-repo."
        exit 1
    fi

    echo -e "${UNDERLINE}üìä Git status:${RESET}"
    git status
    echo

    echo "------------------------------"
    echo -e "${YELLOW}‚û°Ô∏è  Vill du l√§gga till alla √§ndringar? (j/n): ${RESET}"
    read ADD
    if [[ "$ADD" =~ ^[Jj]$ ]]; then
        add_with_preview
    else
        echo "‚è≠Ô∏è  Hoppar √∂ver git add."
    fi

    echo "------------------------------"
    echo -e "${YELLOW}‚û°Ô∏è  Vill du skapa en commit? (j/n): ${RESET}"
    read COMMIT
    if [[ "$COMMIT" =~ ^[Jj]$ ]]; then
        set_user_if_missing
        read -p "üìù Commit-meddelande: " MESSAGE
        git commit -m "$MESSAGE"
        echo "‚úÖ Commit skapad."
    else
        echo "‚è≠Ô∏è  Ingen commit skapad."
    fi
    echo

    echo "------------------------------"
    echo -e "${YELLOW}‚û°Ô∏è  Vill du pusha till GitHub nu? (j/n): ${RESET}"
    read PUSH
    if [[ "$PUSH" =~ ^[Jj]$ ]]; then
        push_to_github
    else
        echo "‚è≠Ô∏è  Push hoppades √∂ver."
    fi
    echo

    echo "------------------------------"
    echo -e "${YELLOW}‚û°Ô∏è  Vill du g√∂ra git pull (h√§mta senaste)? (j/n): ${RESET}"
    read PULL
    if [[ "$PULL" =~ ^[Jj]$ ]]; then
        git pull
        echo "‚úÖ Pull klar."
    else
        echo "‚è≠Ô∏è  Ingen pull gjord."
    fi
    echo

    echo "------------------------------"
    echo -e "${GREEN}üéâ Klart! Git-status nu:${RESET}"
    git status
    echo
fi
